version: '3.9'

services:
  ledger-sync-aggregation:
    image: cardanofoundation/ledger-sync-aggregation:dev
    container_name: ledger-sync-aggregation-${NETWORK:-mainnet}
    #    build:
    #      context: .
    #      dockerfile: Dockerfile
    #      target: aggregation
    environment:
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:postgresql://ledger-sync-postgres:5432/ledger_sync?currentSchema=aggregation}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-cardano-master}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-dbpass}
      - STORE_CARDANO_HOST=${STORE_CARDANO_HOST:-relays-new.cardano-mainnet.iohk.io}
      - STORE_CARDANO_PORT=${STORE_CARDANO_PORT:-3001}
      - STORE_CARDANO_PROTOCOLMAGIC=${STORE_CARDANO_PROTOCOLMAGIC:-764824073}
      - NETWORK=${NETWORK:-mainnet}
      - HEALTH_CHECK_ENABLED=${HEALTH_CHECK_ENABLED:-true}
      - EVENT_TIME_THRESHOLD_IN_SECOND=${EVENT_TIME_THRESHOLD_IN_SECOND:-600}
      - BLOCK_TIME_CHECK_ENABLED=${BLOCK_TIME_CHECK_ENABLED:-true}
      - BLOCK_TIME_THRESHOLD_IN_SECOND=${BLOCK_TIME_THRESHOLD_IN_SECOND:-180}
      - STORE_ACCOUNT_INITIALBALANCESNAPSHOTBLOCK=${STORE_ACCOUNT_INITIALBALANCESNAPSHOTBLOCK:-0}
      - STORE_ACCOUNT_BALANCECALCJOBBATCHSIZE=${STORE_ACCOUNT_BALANCECALCJOBBATCHSIZE:-500}
      - STORE_ACCOUNT_BALANCECALCJOBPARTITIONSIZE=${STORE_ACCOUNT_BALANCECALCJOBPARTITIONSIZE:-5}
      - STORE_ADMIN_HEALTHCHECKINTERVAL=${STORE_ADMIN_HEALTHCHECKINTERVAL:-120}
      - STORE_ADMIN_AUTORECOVERYENABLED=${STORE_ADMIN_AUTORECOVERYENABLED:-true}
    ports:
      - ${PORT:-8081}:8080
    volumes:
      - $PWD/logs:/app/logs

    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "50"
